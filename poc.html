import React, { useState, useEffect, useRef, useMemo } from 'react';

// --- Helper Functions & Initial Data ---

const parseWorkoutString = (workoutStr) => {
    const multiplierRegex = /\s*x(\d*\.?\d+)\s*$/;
    const match = workoutStr.match(multiplierRegex);
    if (match) {
        const name = workoutStr.replace(multiplierRegex, '').trim();
        const multiplier = Math.round(parseFloat(match[1]));
        return { name, multiplier: Math.max(1, multiplier) };
    }
    return { name: workoutStr.trim(), multiplier: 1 };
};

const createWorkoutUrl = (name) => `https://www.google.com/search?q=${encodeURIComponent(name + ' workout')}`;

const initialWorkoutStrings = [
    "Simple & Sinister", "ABC x3", "AXE Snatch", "AXE KB Swing",
    "Snatch Test x2", "AXE Macebell Touch Down x.5",
    "AXE Macebell Uppercuts x.5", "Deadlift"
];

const initialMasterWorkouts = initialWorkoutStrings.map(str => {
    const parsed = parseWorkoutString(str);
    return { id: crypto.randomUUID(), ...parsed, url: createWorkoutUrl(parsed.name) };
});

// Updated color palette for a more classic, bright look
const COLORS = ["#3b82f6", "#22c55e", "#ef4444", "#f97316", "#8b5cf6", "#d946ef", "#14b8a6", "#eab308"];


// --- React Components ---

const KettlebellIcon = () => (
    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
        <path d="M6 9H4a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h1a3 3 0 0 1 3 3v1Zm12 0h-2V8a3 3 0 0 1 3-3h1a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2Zm-2.92 2h-6.16a5.51 5.51 0 0 0-5.46 6A5.55 5.55 0 0 0 9.01 22a5.67 5.67 0 0 0 5.53-4.59A5.52 5.52 0 0 0 15.08 11Z M9 5a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1v1h4V5ZM15 5v1h4V5a1 1 0 0 0-1-1h-1a1 1 0 0 0-1 1Z"></path>
    </svg>
);


const Wheel = ({ displayWorkouts, onSpinFinish }) => {
    const canvasRef = useRef(null);
    const [isSpinning, setIsSpinning] = useState(false);
    const [currentRotation, setCurrentRotation] = useState(0);

    useEffect(() => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        const numOptions = displayWorkouts.length;
        const arcSize = numOptions > 0 ? (2 * Math.PI) / numOptions : 0;
        const size = canvas.width;
        const center = size / 2;
        const radius = center - 2;

        ctx.clearRect(0, 0, size, size);
        ctx.save();
        ctx.translate(center, center);
        ctx.rotate(currentRotation);
        ctx.translate(-center, -center);

        if (numOptions === 0) {
            ctx.beginPath();
            ctx.arc(center, center, radius, 0, 2 * Math.PI);
            ctx.fillStyle = '#f8fafc';
            ctx.fill();
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 2;
            ctx.stroke();

            ctx.fillStyle = '#64748b';
            ctx.font = `500 ${size * 0.07}px 'Inter'`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('Add Workouts', center, center);
            ctx.restore();
            return;
        }

        for (let i = 0; i < numOptions; i++) {
            const angle = i * arcSize;
            // Draw wedge
            ctx.beginPath();
            ctx.arc(center, center, radius, angle, angle + arcSize);
            ctx.lineTo(center, center);
            ctx.closePath();
            ctx.fillStyle = COLORS[i % COLORS.length];
            ctx.fill();
            
            // Draw separator lines
            ctx.save();
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(center, center);
            ctx.lineTo(center + Math.cos(angle) * radius, center + Math.sin(angle) * radius);
            ctx.stroke();
            ctx.restore();

            // Draw text
            ctx.save();
            ctx.fillStyle = 'white';
            const textAngle = angle + arcSize / 2;
            const textRadius = radius * 0.6;
            const textX = center + Math.cos(textAngle) * textRadius;
            const textY = center + Math.sin(textAngle) * textRadius;
            
            ctx.translate(textX, textY);
            let rotation = textAngle;
            if (rotation > Math.PI / 2 && rotation < 3 * Math.PI / 2) {
                rotation += Math.PI;
            }
            ctx.rotate(rotation);

            const text = displayWorkouts[i].name;
            const maxTextWidth = radius * 0.45;
            let fontSize = size * 0.035;
            ctx.font = `600 ${fontSize}px 'Inter'`;
            while (ctx.measureText(text).width > maxTextWidth && fontSize > 8) {
                fontSize--;
                ctx.font = `600 ${fontSize}px 'Inter'`;
            }
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, 0, 0);
            ctx.restore();
        }
        ctx.restore();

        // Add a center circle for a cleaner look
        ctx.beginPath();
        ctx.arc(center, center, size * 0.1, 0, 2 * Math.PI);
        ctx.fillStyle = '#1e293b'; // Slate 800
        ctx.fill();
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
        ctx.lineWidth = 4;
        ctx.stroke();

    }, [displayWorkouts, currentRotation]);

    const handleSpin = () => {
        if (isSpinning || displayWorkouts.length === 0) return;
        setIsSpinning(true);

        const totalRotations = Math.floor(Math.random() * 5) + 8;
        const randomStopAngle = Math.random() * 2 * Math.PI;
        const targetRotation = totalRotations * 2 * Math.PI + randomStopAngle;
        
        const start = performance.now();
        const duration = 7000;

        const animate = (time) => {
            const elapsed = time - start;
            if (elapsed >= duration) {
                const finalRotation = targetRotation % (2 * Math.PI);
                setCurrentRotation(finalRotation);
                finishSpin(finalRotation);
                return;
            }
            const progress = elapsed / duration;
            const easedProgress = 1 - Math.pow(1 - progress, 4);
            setCurrentRotation(targetRotation * easedProgress);
            requestAnimationFrame(animate);
        };

        requestAnimationFrame(animate);
    };

    const finishSpin = (finalRotation) => {
        const numOptions = displayWorkouts.length;
        const arcSize = (2 * Math.PI) / numOptions;
        const finalAngle = (2 * Math.PI - (finalRotation % (2 * Math.PI)) + (1.5 * Math.PI)) % (2 * Math.PI);
        const winnerIndex = Math.floor(finalAngle / arcSize);
        const winner = displayWorkouts[winnerIndex];
        
        onSpinFinish(winner);
        setIsSpinning(false);
    };

    return (
        <div className="lg:col-span-2 bg-white p-4 sm:p-6 rounded-lg shadow-sm border border-slate-200">
            <div className="relative w-full pt-[100%] h-0">
                <div className="absolute left-1/2 top-[-15px] -translate-x-1/2 w-0 h-0 border-l-[15px] border-l-transparent border-r-[15px] border-r-transparent border-t-[25px] border-t-slate-800 z-10"></div>
                <canvas ref={canvasRef} width="600" height="600" className="absolute top-0 left-0 w-full h-full"></canvas>
                <button 
                    onClick={handleSpin} 
                    disabled={isSpinning}
                    className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-20 h-20 rounded-full bg-slate-800 text-white border-4 border-white font-semibold cursor-pointer z-20 flex items-center justify-center text-lg uppercase transition-all ease-in-out shadow-lg hover:not-disabled:bg-slate-700 disabled:cursor-not-allowed disabled:bg-slate-400 font-['Inter'] tracking-wider"
                >
                    SPIN
                </button>
            </div>
        </div>
    );
};


const WorkoutManager = ({ workouts, setWorkouts }) => {
    const addWorkout = (e) => {
        e.preventDefault();
        const form = e.target;
        const name = form.workoutName.value.trim();
        const url = form.workoutUrl.value.trim();
        const multiplier = parseInt(form.workoutMultiplier.value, 10) || 1;
        if (name && url) {
            setWorkouts(prev => [...prev, { id: crypto.randomUUID(), name, url, multiplier }]);
            form.reset();
            form.workoutMultiplier.value = 1;
        }
    };

    const deleteWorkout = (id) => {
        setWorkouts(prev => prev.filter(w => w.id !== id));
    };

    return (
        <div className="bg-white p-6 rounded-lg shadow-sm border border-slate-200 flex flex-col">
            <h2 className="text-2xl text-center mb-4 text-slate-800 font-bold uppercase tracking-widest">Workout Arsenal</h2>
            
            <div className="flex-grow overflow-y-auto pr-2 mb-6 max-h-[300px] lg:max-h-none workout-list">
                {workouts.length === 0 ? (
                    <div className="text-center py-10 border-2 border-dashed border-slate-200 rounded-md">
                      <p className="text-slate-500">Your arsenal is empty.</p>
                      <p className="text-slate-400 text-sm">Add a workout below.</p>
                    </div>
                ) : (
                    <div className="space-y-2">
                        {workouts.map((workout) => (
                            <div key={workout.id} className="flex items-center justify-between bg-slate-50 p-3 rounded-md border border-slate-200">
                                <span className="font-medium text-slate-700 truncate pr-2">{workout.name} <span className="text-slate-500 text-xs font-semibold">(x{workout.multiplier})</span></span>
                                <button onClick={() => deleteWorkout(workout.id)} className="flex-shrink-0 text-slate-400 hover:text-red-500 transition-colors p-1 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" /></svg>
                                </button>
                            </div>
                        ))}
                    </div>
                )}
            </div>

            <div>
                <h3 className="text-xl text-center mb-4 text-slate-800 font-bold uppercase tracking-widest">Add Challenge</h3>
                <form onSubmit={addWorkout} className="space-y-3">
                    <input type="text" name="workoutName" placeholder="Workout Name" required className="mt-1 block w-full bg-slate-50 border border-slate-300 rounded-md shadow-sm py-2 px-3 text-slate-900 focus:outline-none focus:ring-1 focus:ring-slate-500 focus:border-slate-500" />
                    <input type="url" name="workoutUrl" placeholder="Workout URL" required className="mt-1 block w-full bg-slate-50 border border-slate-300 rounded-md shadow-sm py-2 px-3 text-slate-900 focus:outline-none focus:ring-1 focus:ring-slate-500 focus:border-slate-500" />
                    <input type="number" name="workoutMultiplier" defaultValue="1" min="1" step="1" required title="Repetitions on Wheel" className="mt-1 block w-full bg-slate-50 border border-slate-300 rounded-md shadow-sm py-2 px-3 text-slate-900 focus:outline-none focus:ring-1 focus:ring-slate-500 focus:border-slate-500" />
                    <button type="submit" className="w-full flex justify-center items-center gap-2 py-2.5 px-4 border border-transparent rounded-md shadow-sm text-sm font-semibold text-white bg-slate-800 hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition-colors">
                        <KettlebellIcon /> Add to Arsenal
                    </button>
                </form>
            </div>
        </div>
    );
};


const ResultModal = ({ winner, onClose }) => {
    if (!winner) return null;

    return (
        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 transition-opacity duration-300">
            <div className="bg-white rounded-lg shadow-2xl p-8 text-center max-w-md w-full transform transition-all scale-100">
                <h2 className="text-sm font-bold text-teal-600 uppercase tracking-widest">Your Destiny Awaits...</h2>
                <p className="text-4xl font-bold text-slate-800 my-3">{winner.name}</p>
                <div className="mt-6 flex flex-col sm:flex-row gap-3 justify-center">
                    <button onClick={() => { window.open(winner.url, '_blank'); onClose(); }} className="w-full sm:w-auto py-2.5 px-6 bg-teal-600 hover:bg-teal-700 text-white font-bold rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">Start Workout!</button>
                    <button onClick={onClose} className="w-full sm:w-auto py-2.5 px-6 bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold rounded-md transition-colors focus:outline-none">Spin Again</button>
                </div>
            </div>
        </div>
    );
};


export default function App() {
    const [masterWorkouts, setMasterWorkouts] = useState(initialMasterWorkouts);
    const [winner, setWinner] = useState(null);
    
    const displayWorkouts = useMemo(() => {
        const expanded = [];
        masterWorkouts.forEach(workout => {
            for (let i = 0; i < workout.multiplier; i++) {
                expanded.push(workout);
            }
        });
        for (let i = expanded.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [expanded[i], expanded[j]] = [expanded[j], expanded[i]];
        }
        return expanded;
    }, [masterWorkouts]);

    return (
        <div className="min-h-screen bg-slate-100 font-['Inter'] text-slate-800">
            <style>{`
                .workout-list::-webkit-scrollbar { width: 8px; }
                .workout-list::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 10px; }
                .workout-list::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
                .workout-list::-webkit-scrollbar-thumb:hover { background: #64748b; }
            `}</style>
            
            <div className="container mx-auto p-4 md:p-8 max-w-7xl">
                <header className="text-center mb-10">
                    <h1 className="text-4xl md:text-5xl font-extrabold tracking-tight text-slate-900 uppercase">
                        <span className="block">Wheel</span>
                        <span className="block text-teal-600 -mt-2 md:-mt-3">Of Gains</span>
                    </h1>
                    <p className="text-slate-500 mt-3 text-lg">Spin the wheel to choose your path to glory!</p>
                </header>

                <main className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <Wheel displayWorkouts={displayWorkouts} onSpinFinish={setWinner} />
                    <WorkoutManager workouts={masterWorkouts} setWorkouts={setMasterWorkouts} />
                </main>
            </div>

            {winner && <ResultModal winner={winner} onClose={() => setWinner(null)} />}
        </div>
    );
}
